From 0 Mon Sep 17 00:00:00 2001
From: "Fr. Br. George" <george@altlinux.org>
Date: Mon, 15 Oct 2012 15:44:28 +0400
Subject: [PATCH] bind-9.9.1-openbsd-owl-chroot-defaults


diff --git a/bind/bin/named/include/named/globals.h b/bind/bin/named/include/named/globals.h
index defaced..defaced 100644
--- a/bind/bin/named/include/named/globals.h
+++ b/bind/bin/named/include/named/globals.h
@@ -122,14 +122,12 @@ EXTERN isc_resourcevalue_t	ns_g_initopenfiles	INIT(0);
  * Misc.
  */
 EXTERN isc_boolean_t		ns_g_coreok		INIT(ISC_TRUE);
-EXTERN const char *		ns_g_chrootdir		INIT(NULL);
+EXTERN const char *		ns_g_chrootdir		INIT("@ROOT@");
 EXTERN isc_boolean_t		ns_g_foreground		INIT(ISC_FALSE);
 EXTERN isc_boolean_t		ns_g_logstderr		INIT(ISC_FALSE);
 EXTERN isc_boolean_t		ns_g_nosyslog		INIT(ISC_FALSE);
 
-EXTERN const char *		ns_g_defaultsessionkeyfile
-					INIT(NS_LOCALSTATEDIR "/run/named/"
-							      "session.key");
+EXTERN const char *		ns_g_defaultsessionkeyfile INIT(NULL);
 
 #if NS_RUN_PID_DIR
 EXTERN const char *		ns_g_defaultpidfile 	INIT(NS_LOCALSTATEDIR
@@ -147,7 +145,7 @@ EXTERN const char *		lwresd_g_defaultpidfile INIT(NS_LOCALSTATEDIR
 EXTERN const char *		ns_g_pidfile		INIT(NS_LOCALSTATEDIR
 							    "/run/named.pid");
 
-EXTERN const char *		ns_g_username		INIT(NULL);
+EXTERN const char *		ns_g_username		INIT("named");
 
 #ifdef USE_PKCS11
 EXTERN const char *		ns_g_engine		INIT("pkcs11");
diff --git a/bind/bin/named/named.8 b/bind/bin/named/named.8
index defaced..defaced 100644
--- a/bind/bin/named/named.8
+++ b/bind/bin/named/named.8
@@ -41,7 +41,7 @@ is a Domain Name System (DNS) server, part of the BIND 9 distribution from ISC.
 .PP
 When invoked without arguments,
 \fBnamed\fR
-will read the default configuration file
+will \fBchroot()\fR to \fI@ROOT@\fR, read the default configuration file
 \fI/etc/named.conf\fR, read any initial data, and listen for queries.
 .SH "OPTIONS"
 .PP
@@ -68,7 +68,7 @@ are mutually exclusive.
 Use
 \fIconfig\-file\fR
 as the configuration file instead of the default,
-\fI/etc/named.conf\fR. To ensure that reloading the configuration file continues to work after the server has changed its working directory due to to a possible
+\fI@ROOT@/etc/named.conf\fR. To ensure that reloading the configuration file continues to work after the server has changed its working directory due to a possible
 \fBdirectory\fR
 option in the configuration file,
 \fIconfig\-file\fR
@@ -158,6 +158,7 @@ reserves some file descriptors for its internal use.
 Chroot to
 \fIdirectory\fR
 after processing the command line arguments, but before reading the configuration file.
+By default, \fBnamed\fR \fBchroot()\fR's to \fI@ROOT@\fR.
 .RS
 .B "Warning:"
 This option should be used in conjunction with the
@@ -186,6 +187,7 @@ may be increased as high as that value, but no higher.
 Setuid to
 \fIuser\fR
 after completing privileged operations, such as creating sockets that listen on privileged ports.
+By default, \fBnamed\fR will run as user \fInamed\fR.
 .RS
 .B "Note:"
 On Linux,
diff --git a/bind/bin/nsupdate/Makefile.in b/bind/bin/nsupdate/Makefile.in
index defaced..defaced 100644
--- a/bind/bin/nsupdate/Makefile.in
+++ b/bind/bin/nsupdate/Makefile.in
@@ -72,7 +72,7 @@ MANOBJS =	${MANPAGES} ${HTMLPAGES}
 
 nsupdate.@O@: nsupdate.c
 	${LIBTOOL_MODE_COMPILE} ${CC} ${ALL_CFLAGS} \
-		-DSESSION_KEYFILE=\"${localstatedir}/run/named/session.key\" \
+		-DSESSION_KEYFILE=\"${localstatedir}/lib/bind/session/session.key\" \
 		-c ${srcdir}/nsupdate.c
 
 nsupdate@EXEEXT@: nsupdate.@O@ ${UOBJS} ${DEPLIBS}
diff --git a/bind/bin/nsupdate/nsupdate.docbook b/bind/bin/nsupdate/nsupdate.docbook
index defaced..defaced 100644
--- a/bind/bin/nsupdate/nsupdate.docbook
+++ b/bind/bin/nsupdate/nsupdate.docbook
@@ -193,7 +193,7 @@
       using the <option>-l</option> flag.  This sets the server address to
       localhost (disabling the <command>server</command> so that the server
       address cannot be overridden).  Connections to the local server will
-      use a TSIG key found in <filename>/var/run/named/session.key</filename>,
+      use a TSIG key found in <filename>/var/lib/bind/session/session.key</filename>,
       which is automatically generated by <command>named</command> if any
       local master zone has set <command>update-policy</command> to
       <command>local</command>.  The location of this key file can be
diff --git a/bind/doc/arm/Bv9ARM-book.xml b/bind/doc/arm/Bv9ARM-book.xml
index defaced..defaced 100644
--- a/bind/doc/arm/Bv9ARM-book.xml
+++ b/bind/doc/arm/Bv9ARM-book.xml
@@ -5275,7 +5275,7 @@ badresp:1,adberr:0,findfail:0,valfail:0]
 		The pathname of the file into which to write a TSIG
 		session key generated by <command>named</command> for use by
 		<command>nsupdate -l</command>.  If not specified, the
-		default is <filename>/var/run/named/session.key</filename>.
+		default is <filename>/var/lib/bind/session/session.key</filename>.
 		(See <xref linkend="dynamic_update_policies"/>, and in
 		particular the discussion of the
 		<command>update-policy</command> statement's
@@ -11792,7 +11792,7 @@ example.com. NS ns2.example.net.
 	      <command>named</command> to generate a TSIG session
 	      key and place it in a file, and to allow that key
 	      to update the zone.  (By default, the file is
-	      <filename>/var/run/named/session.key</filename>, the key
+	      <filename>/var/lib/bind/session/session.key</filename>, the key
 	      name is "local-ddns" and the key algorithm is HMAC-SHA256,
 	      but these values are configurable with the
 	      <command>session-keyfile</command>,
