From 65f22166b7bcb26b9c6f52143fea0442d102fccf Mon Sep 17 00:00:00 2001
From: - <->
Date: Mon, 15 Oct 2012 15:44:28 +0400
Subject: [PATCH] owl-checkconf-chroot


diff --git a/bind/bin/check/named-checkconf.8 b/bind/bin/check/named-checkconf.8
index 68755b3..48d3c1c 100644
--- a/bind/bin/check/named-checkconf.8
+++ b/bind/bin/check/named-checkconf.8
@@ -89,6 +89,7 @@ Chroot to
 directory
 so that include directives in the configuration file are processed as if run by a similarly chrooted
 \fBnamed\fR\&.
+By default, \fBnamed\-checkconf\fR will \fBchroot()\fR to \fI@ROOT@\fR.
 .RE
 .PP
 \-v
diff --git a/bind/bin/check/named-checkconf.c b/bind/bin/check/named-checkconf.c
index 43694a7..52a29c7 100644
--- a/bind/bin/check/named-checkconf.c
+++ b/bind/bin/check/named-checkconf.c
@@ -516,6 +516,7 @@ main(int argc, char **argv) {
 	int exit_status = 0;
 	isc_entropy_t *ectx = NULL;
 	isc_boolean_t load_zones = ISC_FALSE;
+	const char *chroot_dir = "@ROOT@";
 	isc_boolean_t print = ISC_FALSE;
 	unsigned int flags = 0;
 
@@ -561,12 +562,7 @@ main(int argc, char **argv) {
 			break;
 
 		case 't':
-			result = isc_dir_chroot(isc_commandline_argument);
-			if (result != ISC_R_SUCCESS) {
-				fprintf(stderr, "isc_dir_chroot: %s\n",
-					isc_result_totext(result));
-				exit(1);
-			}
+			chroot_dir = isc_commandline_argument;
 			break;
 
 		case 'p':
@@ -610,6 +606,20 @@ main(int argc, char **argv) {
 
 	if (isc_commandline_index + 1 < argc)
 		usage();
+
+	result = isc_dir_chroot(chroot_dir);
+	if (result != ISC_R_SUCCESS) {
+		fprintf(stderr, "isc_dir_chroot: %s\n",
+			isc_result_totext(result));
+		exit(1);
+	}
+	result = isc_dir_chdir("/");
+	if (result != ISC_R_SUCCESS) {
+		fprintf(stderr, "isc_dir_chdir: %s\n",
+			isc_result_totext(result));
+		exit(1);
+	}
+
 	if (argv[isc_commandline_index] != NULL)
 		conffile = argv[isc_commandline_index];
 	if (conffile == NULL || conffile[0] == '\0')
-- 
2.10.5

