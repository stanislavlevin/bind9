From a666a7f8133dfd44ec3e020d1b223e23de9d80b0 Mon Sep 17 00:00:00 2001
From: - <->
Date: Mon, 15 Oct 2012 15:44:28 +0400
Subject: [PATCH] openbsd-owl-chroot-defaults


diff --git a/bind/bin/named/include/named/globals.h b/bind/bin/named/include/named/globals.h
index f90ddab..2eedde3 100644
--- a/bind/bin/named/include/named/globals.h
+++ b/bind/bin/named/include/named/globals.h
@@ -118,15 +118,13 @@ EXTERN isc_resourcevalue_t	ns_g_initopenfiles	INIT(0);
  * Misc.
  */
 EXTERN bool			ns_g_coreok		INIT(true);
-EXTERN const char *		ns_g_chrootdir		INIT(NULL);
+EXTERN const char *		ns_g_chrootdir		INIT("@ROOT@");
 EXTERN bool			ns_g_foreground		INIT(false);
 EXTERN bool			ns_g_logstderr		INIT(false);
 EXTERN bool			ns_g_nosyslog		INIT(false);
 EXTERN const char *		ns_g_logfile		INIT(NULL);
 
-EXTERN const char *		ns_g_defaultsessionkeyfile
-					INIT(NS_LOCALSTATEDIR "/run/named/"
-							      "session.key");
+EXTERN const char *		ns_g_defaultsessionkeyfile INIT(NULL);
 EXTERN const char *		ns_g_defaultlockfile	INIT(NS_LOCALSTATEDIR
 							     "/run/named/"
 							     "named.lock");
@@ -156,7 +154,7 @@ EXTERN const char *		ns_g_defaultdnstap
 EXTERN const char *		ns_g_defaultdnstap	INIT(NULL);
 #endif /* HAVE_DNSTAP */
 
-EXTERN const char *		ns_g_username		INIT(NULL);
+EXTERN const char *		ns_g_username		INIT("named");
 
 #if defined(USE_PKCS11)
 EXTERN const char *		ns_g_engine		INIT(PKCS11_ENGINE);
diff --git a/bind/bin/named/named.8 b/bind/bin/named/named.8
index 81181df..00adfd8 100644
--- a/bind/bin/named/named.8
+++ b/bind/bin/named/named.8
@@ -47,7 +47,7 @@ is a Domain Name System (DNS) server, part of the BIND 9 distribution from ISC\&
 .PP
 When invoked without arguments,
 \fBnamed\fR
-will read the default configuration file
+will \fBchroot()\fR to \fI@ROOT@\fR, read the default configuration file
 /etc/named\&.conf, read any initial data, and listen for queries\&.
 .SH "OPTIONS"
 .PP
@@ -74,7 +74,7 @@ are mutually exclusive\&.
 Use
 \fIconfig\-file\fR
 as the configuration file instead of the default,
-/etc/named\&.conf\&. To ensure that reloading the configuration file continues to work after the server has changed its working directory due to to a possible
+@ROOT@/etc/named\&.conf\&. To ensure that reloading the configuration file continues to work after the server has changed its working directory due to to a possible
 \fBdirectory\fR
 option in the configuration file,
 \fIconfig\-file\fR
@@ -208,6 +208,7 @@ reserves some file descriptors for its internal use\&.
 Chroot to
 \fIdirectory\fR
 after processing the command line arguments, but before reading the configuration file\&.
+By default, \fBnamed\fR \fBchroot()\fR's to \fI@ROOT@\fR.
 .if n \{\
 .sp
 .\}
@@ -247,6 +248,7 @@ may be increased as high as that value, but no higher\&. On Windows, the number
 Setuid to
 \fIuser\fR
 after completing privileged operations, such as creating sockets that listen on privileged ports\&.
+By default, \fBnamed\fR will run as user \fInamed\fR.
 .if n \{\
 .sp
 .\}
diff --git a/bind/bin/nsupdate/Makefile.in b/bind/bin/nsupdate/Makefile.in
index 21d5c61..0a773e7 100644
--- a/bind/bin/nsupdate/Makefile.in
+++ b/bind/bin/nsupdate/Makefile.in
@@ -64,7 +64,7 @@ MANOBJS =	${MANPAGES} ${HTMLPAGES}
 
 nsupdate.@O@: nsupdate.c
 	${LIBTOOL_MODE_COMPILE} ${CC} ${ALL_CFLAGS} \
-		-DSESSION_KEYFILE=\"${localstatedir}/run/named/session.key\" \
+		-DSESSION_KEYFILE=\"${localstatedir}/lib/bind/session/session.key\" \
 		-c ${srcdir}/nsupdate.c
 
 nsupdate@EXEEXT@: nsupdate.@O@ ${UOBJS} ${DEPLIBS}
diff --git a/bind/bin/nsupdate/nsupdate.docbook b/bind/bin/nsupdate/nsupdate.docbook
index eaef76c..11e487a 100644
--- a/bind/bin/nsupdate/nsupdate.docbook
+++ b/bind/bin/nsupdate/nsupdate.docbook
@@ -193,7 +193,7 @@
 	    Local-host only mode. This sets the server address to
 	    localhost (disabling the <command>server</command> so that the server
 	    address cannot be overridden).  Connections to the local server will
-	    use a TSIG key found in <filename>/var/run/named/session.key</filename>,
+	    use a TSIG key found in <filename>/var/lib/bind/session/session.key</filename>,
 	    which is automatically generated by <command>named</command> if any
 	    local master zone has set <command>update-policy</command> to
 	    <command>local</command>.  The location of this key file can be
@@ -851,7 +851,7 @@
       </varlistentry>
 
       <varlistentry>
-	<term><constant>/var/run/named/session.key</constant></term>
+	<term><constant>/var/lib/bind/session/session.key</constant></term>
 	<listitem>
 	  <para>
 	    sets the default TSIG key for use in local-only mode
diff --git a/bind/doc/arm/Bv9ARM-book.xml b/bind/doc/arm/Bv9ARM-book.xml
index 3f0096a..8ca7c1c 100644
--- a/bind/doc/arm/Bv9ARM-book.xml
+++ b/bind/doc/arm/Bv9ARM-book.xml
@@ -5003,7 +5003,7 @@ badresp:1,adberr:0,findfail:0,valfail:0]
 		The pathname of the file into which to write a TSIG
 		session key generated by <command>named</command> for use by
 		<command>nsupdate -l</command>.  If not specified, the
-		default is <filename>/var/run/named/session.key</filename>.
+		default is <filename>/var/lib/bind/session/session.key</filename>.
 		(See <xref linkend="dynamic_update_policies"/>, and in
 		particular the discussion of the
 		<command>update-policy</command> statement's
@@ -12427,7 +12427,7 @@ example.com. NS ns2.example.net.
 	      be used by local clients to update the zone while
 	      <command>named</command> is running.
 	      By default, the session key is stored in the file
-	      <filename>/var/run/named/session.key</filename>, the key name
+	      <filename>/var/lib/bind/session/session.key</filename>, the key name
 	      is "local-ddns", and the key algorithm is HMAC-SHA256.
 	      These values are configurable with the
 	      <command>session-keyfile</command>,
-- 
2.10.5

