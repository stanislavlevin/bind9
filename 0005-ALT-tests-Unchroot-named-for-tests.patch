From ca6e1181c7b3e87cf82fe6cefb100fa9370ecd56 Mon Sep 17 00:00:00 2001
From: Stanislav Levin <slev@altlinux.org>
Date: Thu, 3 Nov 2022 18:35:19 +0300
Subject: [PATCH] ALT: tests: Unchroot named for tests

Upstream tests runner expects unchrooted named.
Exposed as ALT_NAMED_OPTIONS=' -t /'.
---
 bind/bin/tests/system/runtime/tests.sh | 2 +-
 bind/bin/tests/system/start.pl         | 5 +++++
 3 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/bind/bin/tests/system/runtime/tests.sh b/bind/bin/tests/system/runtime/tests.sh
index 81184099b81..70212814e2a 100644
--- a/bind/bin/tests/system/runtime/tests.sh
+++ b/bind/bin/tests/system/runtime/tests.sh
@@ -18,7 +18,7 @@ SYSTEMTESTTOP=..
 set -e
 
 RNDCCMD="$RNDC -c ../_common/rndc.conf -p ${CONTROLPORT} -s"
-NAMED_DEFAULT_ARGS="-m record -d 99 -g -U 4"
+NAMED_DEFAULT_ARGS="-m record -d 99 -g -U 4 $ALT_NAMED_OPTIONS"
 
 kill_named() {
 	pidfile="${1}"
diff --git a/bind/bin/tests/system/start.pl b/bind/bin/tests/system/start.pl
index 657d9880807..1cf465ff5eb 100755
--- a/bind/bin/tests/system/start.pl
+++ b/bind/bin/tests/system/start.pl
@@ -286,6 +286,11 @@ sub construct_ns_command {
 		$command .= " -T notcp"
 	}
 
+	# ALT specific: chrooted by default, so it must be unchrooted for tests
+	if ($ENV{'ALT_NAMED_OPTIONS'}) {
+		$command .= $ENV{'ALT_NAMED_OPTIONS'}
+	}
+
 	if ($restart) {
 		$command .= " >>named.run 2>&1 &";
 	} else {
diff --git a/bind/bin/tests/system/shutdown/tests_shutdown.py b/bind/bin/tests/system/shutdown/tests_shutdown.py
index 89cada2bb77..3fe1e3b562b 100755
--- a/bind/bin/tests/system/shutdown/tests_shutdown.py
+++ b/bind/bin/tests/system/shutdown/tests_shutdown.py
@@ -188,6 +188,8 @@ def test_named_shutdown(named_port, control_port, kill_method):
     resolver.port = named_ports.dns
 
     named_cmdline = [named, "-c", cfg_file, "-d", "99", "-g"]
+    # ALT options for named
+    named_cmdline.extend(os.getenv("ALT_NAMED_OPTIONS", "").split())
     with open(os.path.join(cfg_dir, "named.run"), "ab") as named_log:
         with subprocess.Popen(
             named_cmdline, cwd=cfg_dir, stderr=named_log
-- 
2.42.1

